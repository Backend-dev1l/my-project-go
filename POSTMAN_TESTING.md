# Инструкция по тестированию API в Postman

## Базовая конфигурация

**Base URL:** `http://127.0.0.1:8080/api/v1`

## Доступные эндпоинты

### 1. POST /create - Создание пользователя

Создает нового пользователя с начальным балансом и доходом.

**URL:** `http://127.0.0.1:8080/api/v1/create`

**Method:** `POST`

**Headers:**
```
Content-Type: application/json
```

**Body (raw JSON):**
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "balance": 1000.50,
  "revenue": 0
}
```

**Успешный ответ (200 OK):**
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "balance": 1000.50,
  "revenue": 0
}
```

---

### 2. POST /deposit - Пополнение баланса

Пополняет баланс существующего пользователя.

**URL:** `http://127.0.0.1:8080/api/v1/deposit`

**Method:** `POST`

**Headers:**
```
Content-Type: application/json
```

**Body (raw JSON):**
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "amount": 500.00
}
```

**Успешный ответ:** `200 OK` (без тела ответа)

---

### 3. POST /reserve - Резервирование средств

Резервирует средства пользователя под конкретный заказ.

**URL:** `http://127.0.0.1:8080/api/v1/reserve`

**Method:** `POST`

**Headers:**
```
Content-Type: application/json
```

**Body (raw JSON):**
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "amount": 250.00,
  "order_id": 12345
}
```

**Успешный ответ:** `200 OK` (без тела ответа)

---

### 4. POST /confirm-revenue - Подтверждение дохода

Подтверждает доход по зарезервированному заказу.

**URL:** `http://127.0.0.1:8080/api/v1/confirm-revenue`

**Method:** `POST`

**Headers:**
```
Content-Type: application/json
```

**Body (raw JSON):**
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000",
  "order_id": 12345
}
```

**Успешный ответ:** `200 OK` (без тела ответа)

---

### 5. GET /balance - Получение баланса

Получает текущий баланс и доход пользователя.

**URL:** `http://127.0.0.1:8080/api/v1/balance`

**Method:** `GET`

**Headers:**
```
Content-Type: application/json
```

**Body (raw JSON):**
```json
{
  "user_id": "550e8400-e29b-41d4-a716-446655440000"
}
```

**Успешный ответ (200 OK):**
```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "balance": 1250.50,
  "revenue": 250.00
}
```

---

## Сценарий тестирования

### Шаг 1: Создание пользователя
1. Отправьте запрос `POST /create` с новым UUID
2. Проверьте, что получили ответ 200 OK

### Шаг 2: Пополнение баланса
1. Отправьте запрос `POST /deposit` с тем же user_id
2. Проверьте, что получили ответ 200 OK

### Шаг 3: Проверка баланса
1. Отправьте запрос `GET /balance`
2. Убедитесь, что баланс увеличился на сумму депозита

### Шаг 4: Резервирование средств
1. Отправьте запрос `POST /reserve` с уникальным order_id
2. Проверьте, что получили ответ 200 OK

### Шаг 5: Проверка баланса после резервирования
1. Отправьте запрос `GET /balance`
2. Убедитесь, что баланс уменьшился на зарезервированную сумму

### Шаг 6: Подтверждение дохода
1. Отправьте запрос `POST /confirm-revenue` с тем же order_id
2. Проверьте, что получили ответ 200 OK

### Шаг 7: Финальная проверка
1. Отправьте запрос `GET /balance`
2. Убедитесь, что revenue увеличился на сумму заказа

---

## Примеры ошибок

### Ошибка валидации (400 Bad Request)
```json
{
  "error": "validate struct error"
}
```

### Внутренняя ошибка сервера (500 Internal Server Error)
```json
{
  "error": "handler create user error"
}
```

---

## Настройка Postman Collection

### Создание переменных окружения

1. Создайте новое окружение "Project-Go Dev"
2. Добавьте переменные:
   - `base_url`: `http://127.0.0.1:8080/api/v1`
   - `user_id`: `550e8400-e29b-41d4-a716-446655440000`
   - `order_id`: `12345`

3. Используйте переменные в запросах:
   - URL: `{{base_url}}/create`
   - Body: `{"user_id": "{{user_id}}"}`

### Генерация случайного UUID

В Postman можно использовать Pre-request Script для генерации UUID:

```javascript
pm.environment.set("user_id", pm.variables.replaceIn('{{$guid}}'));
```

---

## Важные замечания

1. **UUID формат:** Все user_id должны быть в формате UUID v4
2. **Decimal значения:** Суммы должны быть числами (например, 100.50, а не строками "100.50")
3. **Order ID:** Должен быть уникальным для каждого резервирования
4. **Последовательность:** Нельзя подтвердить доход без предварительного резервирования
5. **Баланс:** Нельзя зарезервировать больше, чем есть на балансе

---

## Запуск приложения

Перед тестированием убедитесь, что:
1. PostgreSQL запущен (через Docker Compose)
2. Применены миграции
3. Приложение запущено на порту 8080

```bash
# Запуск через Docker Compose
docker-compose up -d

# Запуск приложения
go run cmd/main.go
```
